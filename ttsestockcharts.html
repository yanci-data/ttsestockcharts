<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TTSE Stock Chart</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  :root{ --navy:#0b1f44; --ink:#0f172a; --muted:#667085; --card:#fff; --border:rgba(11,31,68,.12); }
  html,body{ margin:0; background:transparent; color:var(--ink);
    font-family:"SF Pro Display","SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,system-ui,sans-serif; }
  .wrap{ max-width:920px; margin:0 auto; padding:12px; }
  .card{ background:var(--card); border-radius:18px; padding:16px; border:1px solid var(--border); }
  .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
  .title{ font-size:18px; font-weight:700; color:var(--navy); }
  .tabs{ display:flex; gap:6px; flex-wrap:wrap; }
  .tab{ border:1px solid var(--border); background:#f8fafc; padding:6px 10px; border-radius:12px; font-size:12px; cursor:pointer }
  .tab.active{ background:#e6f0ff; border-color:#c7d7ff; }
  canvas{ width:100%; height:420px; border-radius:14px; }
  .muted{ font-size:12px; color:var(--muted); }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <div class="title" id="t"></div>
          <div class="muted" id="sub"></div>
        </div>
        <div class="tabs" id="tabs">
          <button class="tab active" data-k="close_price">Close</button>
          <button class="tab" data-k="change_dollar">Δ $</button>
          <button class="tab" data-k="change_pct">Δ %</button>
          <button class="tab" data-k="trade_volume">Volume</button>
        </div>
      </div>
      <canvas id="c"></canvas>
    </div>
  </div>

<script>
const WORKER = "https://YOUR_WORKER_BASE.workers.dev"; // <-- change this
const qp = new URLSearchParams(location.search);
const symbol = (qp.get("symbol") || "").toUpperCase();
document.getElementById("t").textContent = symbol ? `${symbol} – Price & Activity` : "Missing symbol";
let chart, rows = [];

async function load(metric="close_price"){
  if(!symbol){ return; }
  const res = await fetch(`${WORKER}/trade-series?symbol=${encodeURIComponent(symbol)}`);
  const data = await res.json();
  if(data.error){ throw new Error(data.error); }
  rows = data.items || [];
  render(metric);
}

function series(metric){
  const xs = rows.map(r => r.d);
  const ys = rows.map(r => (r[metric] ?? null));
  return { xs, ys };
}

function render(metric){
  const { xs, ys } = series(metric);
  const ctx = document.getElementById("c").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: metric === "trade_volume" ? "bar" : "line",
    data: {
      labels: xs,
      datasets: [{ data: ys, borderWidth: 2, tension: 0.2 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display:false },
        tooltip: { mode:"index", intersect:false }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: metric !== "close_price" }
      }
    }
  });
  document.getElementById("sub").textContent = `Data points: ${rows.length}`;
}

document.getElementById("tabs").addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-k]");
  if(!btn) return;
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  render(btn.dataset.k);
});

load().catch(err => {
  document.getElementById("sub").textContent = err.message;
});
</script>
</body>
</html>
